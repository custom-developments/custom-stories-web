<html>
    <head>
        <title>Logging in...</title>
    </head>
    <body>
        <p id="info">Logging in...</p>
        <div id="content"></div>

        <script type="module">
            load();

            const escapeHTML = c => c.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/\'/g, '&#39;').replace(/\//g, '&#x2F;');

            async function load() {
                try {
                    const userReq = await fetch("http://localhost:8001/user", {
                        credentials: "include"
                    });
                    const user = await userReq.json();

                    if (user.error) {
                        switch (user.error) {
                            case "not_logged_in":
                                window.location.href = "/";
                                break;
                            default:
                                throw user.error;
                                break;
                        }
                        return;
                    }

                    document.getElementById("info").innerHTML = JSON.stringify(user);

                    const guilds = [];

                    for (const guild of user.guilds.manage.concat(user.guilds.invite)) {
                        guilds.push(`
                            <a href="/manage/${guild.id}">
                                <img src="${
                                    guild.icon ? 
                                    `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` :
                                    `https://customrpg.xyz/assets/images/logo.png`
                                }" width=100>
                                
                                ${guild.name} (click to ${user.guilds.manage.find(g => guild.id === g.id) ? "manage" : "invite"})
                            </a>
                        `);
                    }

                    document.getElementById("content").innerHTML = `
                        <!-- Make sure to check if the user doesn't have an avatar too. -->
                        <img src="https://cdn.discordapp.com/avatars/${user.user.id}/${user.user.avatar}">

                        <h3>Hey, ${escapeHTML(user.user.username)}</h3><br><br>

                        ${guilds.join("<br><br>")}
                    `;
                } catch(err) {
                    console.error(err);
                    setTimeout(() => {
                        load();
                    }, 5000);
                }
            }
        </script>
    </body>
</html>